---
title: "CIS 2020 analisis EQUO"
subtitle: "Análisis de datos de encuestas de EQUO y Podemos"
author: "ImJaviPerez"
date: "Marzo 2023"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[RO,RE]{AnálisiS parcial}
- \fancyfoot{}
- \fancyfoot[RE,LO]{Votos 2020}
- \fancyfoot[LE,RO]{\thepage}
bibliography: BibliografiaME.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE)

#    include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
#    echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
#    message = FALSE prevents messages that are generated by code from appearing in the finished file.
#    warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#    fig.cap = "..." adds a caption to graphical results.
#    results='asis' = output as-is, i.e., write raw results from R into the output document
```


```{r include=FALSE}
# Borrar toda las variables
### rm(list=ls())
```

***
```{r}
# List of libraries
library(foreign)
library(dplyr)
library(pander)
library(car)
library(ca)

library(ggplot2)
library(ggrepel)

```

```{r}
library(log4r)
# Create a new logger object with create.logger().
logger <- create.logger()
# Set the logger's file output.
logfile(logger) <- 'cis_2020_analisis.log'
# Set the current level of the logger.
level(logger) <- "DEBUG"
#level(logger) <- "INFO"
# At priority level INFO, a call to debug() won't print anything.
# debug(logger, 'A Debugging Message')
info(logger,  paste(Sys.time(), 'Starting script'))
# warn(logger, 'A Warning Message')
# error(logger, 'An Error Message')
# fatal(logger, 'A Fatal Error Message')

```


```{r}
# TODO
# http://destio.us.es/calvo/asignaturas/ge_esco/tutorialusargitgithubrstudio/UsarGitGithubconRStudio.html
# Seguir indicaciones de JRB
```


\pagebreak

# Análisis de correspondencias múltiples
Datos cualitativos procedentes de encuestas realizadas por el  [Centro de Investigaciones Sociológicas (CIS)](https://www.cis.es) en septiembre de 2020:
[Encuesta 3293/0 POSTELECTORAL DEL PAÍS VASCO. ELECCIONES AUTONÓMICAS 2020](https://www.cis.es/cis/opencm/ES/1_encuestas/estudios/listaMuestras.jsp?estudio=14522).

# Descripción del fichero de datos.

Para conocer las preguntas consultar el fichero: "Estudio: Postelectoral Autonómicas País Vasco 2020 Clave: ECIS3293" del link mencionado anteriormente.


```{r}
# We have to filter CIS 2020 data previously. It spends a lot of time for it's calculations, thus we have made those calculations in an other script and now we load those results.
require(log4r)

cis_2020_cuisine_file <- file.path(getwd(), "cis_2020_equo_cuisine.RData")
if (file.exists(cis_2020_cuisine_file)) {
  load(cis_2020_cuisine_file)
  log4r::info(logger, paste("cis_2020_cuisine_file (", cis_2020_cuisine_file, ") exists =", file.exists(cis_2020_cuisine_file)))
}else{
  log4r::error(logger, paste("File", cis_2020_cuisine_file, "DO NOT EXISTS. You must create this file using the script Cuisine.Rmd"))
  stop(paste("File", cis_2020_cuisine_file, "DO NOT EXISTS. You must create this file using the script Cuisine.Rmd"))}
```

```{r}
# P20 pollitical parties indices
# levels(cis_2020_df$P20)
P20_idx_11_pnv <- 5
P20_idx_12_bildu <- 6
P20_idx_2_psoe <- 2
P20_idx_21_podem <- 10
P20_idx_1_pp <- 1
P20_idx_18_vox <- 8
P20_idx_95_otro <- 14
P20_idx_96_blan <- 15
P20_idx_77_nul <- 13
P20_idx_97_abs <- 16
P20_idx_98_nr <- 17
P20_idx_99_nc <- 18

P20_idx_ciu <- 3
P20_idx_iu <- 4
P20_idx_pacm <- 7
P20_idx_ver <- 9
P20_idx_equ <- 11
P20_idx_escBl <- 12

# Test
# levels(cis_2020_df$P20)[c(P20_idx_1_pp, P20_idx_2_psoe, P20_idx_ciu, P20_idx_iu, P20_idx_11_pnv, P20_idx_12_bildu, P20_idx_pacm, P20_idx_18_vox, P20_idx_ver, P20_idx_21_podem, P20_idx_equ, P20_idx_escBl, P20_idx_77_nul, P20_idx_95_otro, P20_idx_96_blan,  P20_idx_97_abs, P20_idx_98_nr, P20_idx_99_nc)]
```


Ahora, realizamos el ACM en todas las columnas seleccionadas:
```{r ACM}
require(ca) 
cis_2020_equo_ca_00 <- mjca(cis_2020_EB_df[, included_cols_EB_idx])
```

Por defecto la función `mjca` toma el método de escalado `lambda = "adjusted"`, con lo que únicamente se consideran los valores propios obtenidos en el ACM mayores que $\frac{1}{Q} =$
```{r echo=FALSE, results='asis'}
eigen_inertia_e <- 1/Q
cat("\\frac{1}{", Q, "} = ",round(1/Q, digits = 4), ".", sep = "")
```

```{r}
cis_2020_equo_ca_00_summ <- summary(cis_2020_equo_ca_00)
numDim <- length(which(cis_2020_equo_ca_00_summ$scree[,2] > (eigen_inertia_e/2)))

if (numDim < 9) numDim <- 9
```
Por lo tanto en nuestro caso el número de dimensiones será:
```{r echo=FALSE, results='asis'}
cat(numDim)
```


## Datos objetivos y datos de opinión
Debemos tener en cuenta que hay una serie de variables que son datos objetivos de la persona como por ejemplo su provincia de empadronamiento. A estas características las llamaremos variables *ilustrativas*, que son:

```{r echo=FALSE, results='asis'}
# cat(paste0("'", included_cols_EB, "'", collapse = ", "), sep = "")
# 'PROV', 'MUN', 'CAPITAL', 'TIPO_TEL', 'SEXO', 'A0a', 'P10_2', 'P10_3', 'P10IMPRESA', 'P10DIGITAL', 'P10TV', 'P10RADIO', 'P11_1', 'P11_2', 'P11_3', 'P11_4', 'P11_5', 'P11_7', 'P12_1', 'P12_2', 'P12_3', 'P12_4', 'P12_5', 'P12_6', 'P12_7', 'P14A_11', 'P14A_12', 'P14A_2', 'P14A_21', 'P14A_1', 'P14A_18', 'P14A_95', 'P14A_98', 'P15A_11', 'P15A_12', 'P15A_2', 'P15A_21', 'P15A_1', 'P15A_18', 'P15A_95', 'P15A_98', 'P16', 'P16A_11', 'P16A_12', 'P16A_2', 'P16A_21', 'P16A_1', 'P16A_18', 'P16A_95', 'P16A_98', 'P17_3', 'P20A_2', 'PARTICIPACIONA', 'P27', 'RELIGION', 'ESTADOCIVIL', 'CNO11', 'RELALAB', 'IA_APLAZADA', 'IA_MODIFICADA', 'IA_SUPERVISADA', 'TAMUNI_GRUPO', 'EDAD_GRUPO', 'P1_GRUPO', 'P1A_GRUPO', 'P1B_GRUPO', 'P2_GRUPO', 'P3_1_GRUPO', 'P3_2_GRUPO', 'P3_3_GRUPO', 'P3_4_GRUPO', 'P4_GRUPO', 'P5_GRUPO', 'P5A_GRUPO', 'P6_GRUPO', 'P7_GRUPO', 'P8_1_GRUPO', 'P8_2_GRUPO', 'P8_3_GRUPO', 'P8_4_GRUPO', 'P9_GRUPO', 'P9A_GRUPO', 'P9B_GRUPO', 'P10_1_GRUPO', 'P10A_GRUPO', 'P10B_GRUPO', 'P10C_GRUPO', 'P10D_GRUPO', 'P13_1_GRUPO', 'P13_2_GRUPO', 'P13_3_GRUPO', 'P13_4_GRUPO', 'P13_5_GRUPO', 'P14_GRUPO', 'P15_GRUPO', 'P17_1_GRUPO', 'P17_2_GRUPO', 'P18_GRUPO', 'P18A_GRUPO', 'P18B_GRUPO', 'P19_GRUPO', 'P19A01_GRUPO', 'P19A02_GRUPO', 'P20_GRUPO', 'P20A_1_GRUPO', 'P21_GRUPO', 'P21A_GRUPO', 'P21B_1_GRUPO', 'P21B_2_GRUPO', 'P22_GRUPO', 'P23_GRUPO', 'P24_1_GRUPO', 'P24_2_GRUPO', 'P24_3_GRUPO', 'P24_4_GRUPO', 'P24_5_GRUPO', 'P24_6_GRUPO', 'P24_7_GRUPO', 'RECUVOTOA_GRUPO', 'P26_1_GRUPO', 'P26_2_GRUPO', 'P26_3_GRUPO', 'P26_4_GRUPO', 'P26_5_GRUPO', 'P26_6_GRUPO', 'P28_GRUPO', 'P29_GRUPO', 'PARTICIPACIONG_GRUPO', 'RECUVOTOG_GRUPO', 'ESCIDEOL_GRUPO', 'ESCIDEOLPAR_1_GRUPO', 'ESCIDEOLPAR_2_GRUPO', 'ESCIDEOLPAR_3_GRUPO', 'ESCIDEOLPAR_4_GRUPO', 'ESCIDEOLPAR_5_GRUPO', 'ESCIDEOLPAR_6_GRUPO', 'ESCIDEOLPAR_7_GRUPO', 'NIVELESTENTREV_GRUPO', 'FRECUENCIARELI_GRUPO', 'SITLAB_GRUPO', 'CLASESOCIAL_GRUPO', 'IA_E1_DIA_GRUPO', 'IA_E2_GRUPO', 'IA_E4_GRUPO', 'IA_C2_GRUPO', 'P19ACOM_GRUPO', 'RVAUTO20_GRUPO', 'RVAUTO16_GRUPO', 'RECUERDO_GRUPO', 'ESTUDIOS_GRUPO', 'CLASESUB_GRUPO'

# Select some illustrative variables
illustrative_vars <- c('PROV', 'MUN', 'CAPITAL', 'TIPO_TEL', 'SEXO', 'A0a', 
                       'PARTICIPACIONA', 'RECUVOTOA_GRUPO', 
                       'PARTICIPACIONG_GRUPO', 'RECUVOTOG_GRUPO', 
                       'ESTADOCIVIL', 'SITLAB_GRUPO', 'CNO11', 'RELALAB', 
                       'IA_APLAZADA', 'IA_MODIFICADA', 'IA_SUPERVISADA', 
                       'RVAUTO20_GRUPO', 'RVAUTO16_GRUPO', 'RECUERDO_GRUPO', 'ESTUDIOS_GRUPO', 
                       'TAMUNI_GRUPO', 'EDAD_GRUPO', 'P1_GRUPO', 'P1A_GRUPO', 'P1B_GRUPO', 'P2_GRUPO', 
                       'ESCUELA_GRUPO', 'NIVELESTENTREV_GRUPO', 
                       'IA_E1_DIA_GRUPO', 'IA_E2_GRUPO', 'IA_E4_GRUPO', 'IA_C2_GRUPO')

# illustrative_vars <- c('RECUVOTOA_GRUPO', 'RECUVOTOG_GRUPO', 'RVAUTO20_GRUPO', 'RVAUTO16_GRUPO', 'RECUERDO_GRUPO')
# Calculate spare variables
opinion_vars <- included_cols_EB[which(!(included_cols_EB %in% illustrative_vars))]

cat(paste0("`",illustrative_vars, "`", collapse = ", "), sep = "")

# length(illustrative_vars) + length(opinion_vars)
```

El resto de preguntas pueden considerarse de opinión. El ACM trata de ubicar los datos objetivos entre las diferentes escalas de opiniones.

# Selección de dimensiones más representativas

Se realiza una primera tentativa de ACM sólo con las variables de opinión:
```{r ACM01}
require(ca)
cis_2020_ca_opi01 <- mjca(cis_2020_EB_df[,opinion_vars], nd = numDim)

cis_2020_ca_opi01_summ <- summary(cis_2020_ca_opi01)
# print(cis_2020_ca_opi01_summ)

plot.mjca(cis_2020_ca_opi01, labels = c(2,0))
# plot.mjca(cis_2020_ca_opi01)
```

Inercias de los autovalores principales:
```{r}
require(pander)
library(pander)
aux_tbl <- as.data.frame(cis_2020_ca_opi01_summ$scree[1:numDim,])
colnames(aux_tbl) <- c("Dim", "Valor", "%", "% acumul")
# panderOptions()
pander(aux_tbl, digits = c(1,5,3,3), keep.trailing.zeros = TRUE, caption = "Porcentaje de varianza explicada por cada autovalor.")
```

```{r}
# Save factors information
# We will get a data.frame with: "name", "mass", " qlt", " inr" and information of every factor: "k", "cor" and "ctr"
require(dplyr)
cis_2020_ca_opi01_factor <- dplyr::bind_rows(cis_2020_ca_opi01_summ$columns)
colnames(cis_2020_ca_opi01_factor) <- c(c("name", "mass", "qlt", "inr"), paste0(c("k", "cor", "ctr"), rep(1:numDim, each=3)))
```

Con 
```{r echo=FALSE, results='asis'}
cat(numDim)
```
 dimensiones se explica el 
```{r echo=FALSE, results='asis'}
# cat(round(100 * sum(cis_2020_ca_opi01$inertia.e[1:numDim]), digits = 1))
cat(cis_2020_ca_opi01_summ$scree[numDim,][4])
```
 % de la varianza.


Seleccionamos las modalidades más importantes de cada factor.
```{r}
percet_eigenvalue <- 0.75
```
```{r}
# Returns a data.frame sorted by contribution. It includes the minimum number of categories that covers percet_eigenvalue
factor_categories <- function(columns_factors, num_factor, percet_eigenvalue){
  k_idx <-   4+3*(num_factor-1)+1
  cor_idx <- 4+3*(num_factor-1)+2
  ctr_idx <- 4+3*(num_factor-1)+3
  
  # Sort by its contribution
  fctr_contribution_sort <- base::sort(columns_factors[,ctr_idx], decreasing = TRUE, index.return = TRUE)
  # Calculate percet_eigenvalue of whole eigenvalue
  i <- round(percet_eigenvalue*sum(columns_factors[,ctr_idx]))
  # Calculate number of variables
  num_categories <- which.max(cumsum(fctr_contribution_sort$x) >= i)
  #  cbind() returns a matrix, and a matrix can only hold one data type we must use data.frame()
  table <- data.frame(1:num_categories,
                      columns_factors$name[fctr_contribution_sort$ix[1:num_categories]],
                      columns_factors$qlt[fctr_contribution_sort$ix[1:num_categories]],
                      columns_factors[,k_idx][fctr_contribution_sort$ix[1:num_categories]],
                      columns_factors[,cor_idx][fctr_contribution_sort$ix[1:num_categories]],
                      fctr_contribution_sort$x[1:num_categories],
                      round(100*fctr_contribution_sort$x[1:num_categories] / sum(fctr_contribution_sort$x), digits = 1))
  
  colnames(table) <- c("n", "Variable:modalidad", "qlt", "k", "cor", "ctr", "%")

  return(table)
}
```

Ya se dijo que se iban a representar 
```{r echo=FALSE, results='asis'}
cat(numDim)
```
 dimensiones.
 
Se analiza el contenido de cada dimensión de una en una teniendo en cuenta el significado de cada parámetro obtenido:

 + `qlt`: representa la *calidad* de esa modalidad. Es el $cos^2$ y mide el grado de asociación de una modalidad con esa dimensión.
 + `k`: nos da las coordenadas de la modalidad en esa dimensión (en ese eje).
 + `cor`: correlaciones al cuadrado entre la modalidad y la dimensión.
 + `ctr`: para interpretar cada dimensión se analizan las contribuciones  absolutas (`ctr`). Esta columna es la que realmente representa cuánto de importante es una modalidad dentro de esa dimensión. 



## Dimensión 1
```{r}
num_categories_per_side <- 35
```


```{r}
i <- 1
# table with big percentage of eigenvalue
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, 0.95)


# Select number of positive categories of table
n_categories_k_positive <- ifelse(length(which(aux_tbl$k > 0)) < num_categories_per_side, length(which(aux_tbl$k > 0)), num_categories_per_side)
# Select number of positive categories of table
n_categories_k_negative <- ifelse(length(which(aux_tbl$k < 0)) < num_categories_per_side, length(which(aux_tbl$k < 0)), num_categories_per_side)
```

En el **lado positivo del eje** las modalidades mejor representadas son:

```{r}
# Show positive categories
aux_idx <- which(aux_tbl$k > 0)[1:n_categories_k_positive]



require(pander)
pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_positive, " modalidades más significativas del eje positivo que abarcan el ", round(100 * sum(aux_tbl$ctr[aux_idx])/sum(cis_2020_ca_opi01_factor[,4+3*(i-1)+3])), " % de la dimensión."))

### pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_positive, " modalidades más significativas del eje positivo."))
```

 + `P15_GRUPO:Sí`: 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P15'])
```

 + `P15A_2:No menciona`, `P15A_1:No menciona`, `P15A_95:No menciona`, `P15A_98:No menciona`, `P15A_11:No menciona`, `P15A_12:No menciona`, `P15A_21:Menciona`, `P15A_18:No menciona`: Los mensajes enviados no han sido de:
```{r echo=FALSE, results='asis'}
# levels(cis_2020_EB_df$P20)
cat(paste(levels(cis_2020_EB_df$P20)[c(P20_idx_2_psoe, P20_idx_1_pp, P20_idx_95_otro, P20_idx_98_nr, P20_idx_11_pnv, P20_idx_12_bildu, P20_idx_21_podem, P20_idx_18_vox)], collapse = ", "))

```
  + `P16A_95:No menciona`, `P16A_98:No menciona`, `P16A_2:No menciona`, `P16A_1:No menciona`, `P16A_18:No menciona`, `P16A_21:Menciona`: 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P16'])
```
. Ha recibido mensajes de:
```{r echo=FALSE, results='asis'}
# levels(cis_2020_EB_df$P20)
cat(paste(levels(cis_2020_EB_df$P20)[c(P20_idx_95_otro, P20_idx_98_nr, P20_idx_2_psoe, P20_idx_1_pp, P20_idx_18_vox, P20_idx_21_podem)], collapse = ", "))
```
  + `P6_GRUPO:Mucho`: está muy interesado en la política.
  + `P17_2_GRUPO:Habitualmente`: Las elecciones fueron tema de conversación 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P17_2'])
```
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P17_2_GRUPO)[1])
```

En resumen: son personas que envían y reciben mensajes relacionados con la política y están interesados en la política


En el **lado negativo del eje** están las "variables:modalidades":

```{r}
# Show negative categories
aux_idx <- which(aux_tbl$k < 0)[1:n_categories_k_negative]
require(pander)

pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_negative, " modalidades más significativas del eje negativo que abarcan el ", round(100 * sum(aux_tbl$ctr[aux_idx])/sum(cis_2020_ca_opi01_factor[,4+3*(i-1)+3])), " % de la dimensión."))

### pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_negative, " modalidades más significativas del eje negativo."))
```


 + `P7_GRUPO:Con ningún interés`: No pusieron ningún interés en seguir la campaña.
 + `ESCIDEOLPAR_6_GRUPO:NS_NC`, `ESCIDEOLPAR_1_GRUPO:NS_NC`, `ESCIDEOLPAR_5_GRUPO:NS_NC`, `ESCIDEOLPAR_2_GRUPO:NS_NC`, `ESCIDEOLPAR_7_GRUPO:NS_NC`, `ESCIDEOLPAR_3_GRUPO:NS_NC`, `ESCIDEOLPAR_4_GRUPO:NS_NC`: No sabe o no contesta sobre la escala ideológica de ningún partido.
 + `RVAUTO20:No votó/abstención`, `P20_GRUPO:Abstención+`: Se abstuvo en el 2020.
 + `P12_7:Menciona`: Tipos de páginas de Internet desde las que se ha seguido la información de las elecciones autonómicas del País Vasco de 2020:
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P12_7'])
```
 
 + `P6_GRUPO:Nada`: 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P6'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P6_GRUPO)[4])
```

 + `P8_1_GRUPO:Nada`: Grado de utilidad de la campaña electoral de las elecciones autonómicas del País Vasco de 2020 en diferentes aspectos de la decisión de voto: 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P8_1'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P8_1_GRUPO)[4])
```

En resumen: personas que no les interesa la campaña electoral, ni la política y que se abstuvieron.


**Necesito una interpretación *certera* del significado de este eje por parte de JRB. A falta de esa interpretación diremos que:** Este eje representa a las personas que sí les interesa, envía mensajes al respecto y habla habitualmente con sus amistades y en el ládo contrario a las que votan abstención o no les interesa la política.



## Dimensión 2

```{r}
i <- 2
# table with big percentage of eigenvalue
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, 0.95)
# Select number of positive categories of table
n_categories_k_positive <- ifelse(length(which(aux_tbl$k > 0)) < num_categories_per_side, length(which(aux_tbl$k > 0)), num_categories_per_side)
# Select number of positive categories of table
n_categories_k_negative <- ifelse(length(which(aux_tbl$k < 0)) < num_categories_per_side, length(which(aux_tbl$k < 0)), num_categories_per_side)
```

En el **lado positivo del eje** las modalidades mejor representadas son:

```{r}
# Show positive categories
aux_idx <- which(aux_tbl$k > 0)[1:n_categories_k_positive]
require(pander)
pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_positive, " modalidades más significativas del eje positivo que abarcan el ", round(100 * sum(aux_tbl$ctr[aux_idx])/sum(cis_2020_ca_opi01_factor[,4+3*(i-1)+3])), " % de la dimensión."))
```
```{r eval=FALSE, include=FALSE, echo=FALSE}
cat(paste0("`", head(aux_tbl$`Variable:modalidad`[which(aux_tbl$k > 0)], n = num_categories_per_side), "`", collapse = ", "), ".", sep = "")
```


 + `P24_5_GRUPO:NS_NC`, `P24_3_GRUPO:NS_NC`, `P24_4_GRUPO:NS_NC`, `P24_7_GRUPO:NS_NC`, `P24_6_GRUPO:NS_NC`, `P24_2_GRUPO:NS_NC`, `P24_1_GRUPO:NS_NC`: Escala de probabilidad (0-10) de votar a diferentes partidos políticos: No saben o no contestan.
 + `ESCIDEOLPAR_6_GRUPO:NS_NC`, `ESCIDEOLPAR_4_GRUPO:NS_NC`, `ESCIDEOLPAR_1_GRUPO:NS_NC`, `ESCIDEOLPAR_7_GRUPO:NS_NC`, `ESCIDEOLPAR_2_GRUPO:NS_NC`, `ESCIDEOLPAR_5_GRUPO:NS_NC``ESCIDEOLPAR_3_GRUPO:NS_NC`: Escala de ubicación ideológica (1-10) de partidos políticos de la comunidad autónoma: No saben o no contestan.
 + `P15_GRUPO:Sí`
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P15'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P15)[1])
```
 + `P15A_98:No menciona`, `P15A_95:No menciona`, `P15A_21:Menciona`, `P15A_1:No menciona`, `P15A_2:No menciona`: Los mensajes enviados no son de: 
```{r echo=FALSE, results='asis'}
# levels(cis_2020_EB_df$P20)
cat(paste(levels(cis_2020_EB_df$P20)[c(P20_idx_98_nr, P20_idx_95_otro, P20_idx_21_podem, P20_idx_1_pp, P20_idx_2_psoe)], collapse = ", "))
```

No sabe o no contesta a qué partido votar, no sabe o no contesta la escala ideológica  de varios partidos, sí envía mensajes electrónicos de ciertos partidos.

En el **lado negativo del eje** están las "variables:modalidades":

```{r}
# Show negative categories
aux_idx <- which(aux_tbl$k < 0)[1:n_categories_k_negative]
require(pander)
pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_negative, " modalidades más significativas del eje negativo que abarcan el ", round(100 * sum(aux_tbl$ctr[aux_idx])/sum(cis_2020_ca_opi01_factor[,4+3*(i-1)+3])), " % de la dimensión."))
```

```{r eval=FALSE, include=FALSE, echo=FALSE}
cat(paste0("`", head(aux_tbl$`Variable:modalidad`[which(aux_tbl$k < 0)], n = n_categories_k_negative), "`", collapse = ", "), ".", sep = "")
```

 + `P16:No` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P16'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P15)[2])
```

 + `P15_GRUPO:No` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P15'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P15)[2])
```
 + `P21_GRUPO:Normalmente vota, pero esta vez no quiso hacerlo` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P21'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P21)[3])
```
 + `P10RADIO:Menciona`, `P10IMPRESA:Menciona`, `P10TV:Menciona` = Fuentes utilizadas para informarse sobre las elecciones autonómicas del País Vasco de 2020
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P10RADIO', 'P10IMPRESA', 'P10TV')], collapse = " / "))
```
 + `P10D_GRUPO:Estatales centro-izquierda` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P10D'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P10D_GRUPO)[3])
```
 + `P10A_GRUPO:Editoriales centro-derecha` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P10A'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P10A_GRUPO)[1])
```
 + `P10C_GRUPO:TV vascas públicas`
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P10C'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P10C_GRUPO)[5])
```
 + `P10_2:Radio` = Fuentes utilizadas para informarse sobre las elecciones autonómicas del País Vasco de 2020, 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P10_2'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P10_2)[4])
```
 + `P28_GRUPO:Me siento más vasco/a que español/a ` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P28'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P28_GRUPO)[4])
```
 + `P11_2:No menciona`, `P11_7:Menciona` = Redes sociales en Internet en las que se tiene cuenta: 
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P11_1', 'P11_7')], collapse = " / "))
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P28_GRUPO)[4])
```
 + `P12_5:No menciona` = Tipos de páginas de Internet desde las que se ha seguido la información de las elecciones autonómicas del País Vasco de 2020: No ha seguido 
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P12_5')], collapse = " / "))
```
 + `RVAUTO20:No votó/abstención` = 
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('RVAUTO20')], collapse = " / "))
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$RVAUTO20)[11])
```
 + `P5_GRUPO:Socialdemocracia` = 
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P5')], collapse = " / "))
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P5_GRUPO)[2])
```
 + `P6_GRUPO:Poco` = 
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P6')], collapse = " / "))
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P6_GRUPO)[3])
``` 
 + `P8_1_GRUPO:Poco`, `P8_2_GRUPO:Poco`, `P8_4_GRUPO:Poco` = Grado de utilidad de la campaña electoral de las elecciones autonómicas del País Vasco de 2020 en diferentes aspectos de la decisión de voto
```{r echo=FALSE, results='asis'}
cat(paste(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) %in% c('P8_1', 'P8_2', 'P8_4')], collapse = " / "))
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P8_1_GRUPO)[3])
``` 

 
No recibe ni envía mensajes electrónicos. Se informó a través de prensa impresa, radio y TV. No sigue la campaña en redes sociales. Se siente más vasco que español. Se abstuvo de votar. Se siente socialdemócrata.

**Necesito una interpretación *certera* del significado de este eje por parte de JRB. A falta de esa interpretación diremos que:** Este eje representa a las personas que envían mensajes electrónicos y dicen que no saben a quién votar y en el lado negativo del eje a los que no envían mensajes ni siguen redes sociales y se sienten socialdemócratas.

## Dimensión 3

```{r}
i <- 3
# table with big percentage of eigenvalue
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, 0.95)
# Select number of positive categories of table
n_categories_k_positive <- ifelse(length(which(aux_tbl$k > 0)) < num_categories_per_side, length(which(aux_tbl$k > 0)), num_categories_per_side)
# Select number of positive categories of table
n_categories_k_negative <- ifelse(length(which(aux_tbl$k < 0)) < num_categories_per_side, length(which(aux_tbl$k < 0)), num_categories_per_side)
```

En el **lado positivo del eje** las modalidades mejor representadas son:

```{r}
# Show positive categories
aux_idx <- which(aux_tbl$k > 0)[1:n_categories_k_positive]
require(pander)
pander(aux_tbl[aux_idx,], caption = paste0("Dimensión ", i, ". Contiene las ", n_categories_k_positive, " modalidades más significativas del eje positivo que abarcan el ", round(100 * sum(aux_tbl$ctr[aux_idx])/sum(cis_2020_ca_opi01_factor[,4+3*(i-1)+3])), " % de la dimensión."))
```
```{r eval=FALSE, include=FALSE, echo=FALSE}
cat(paste0("`", head(aux_tbl$`Variable:modalidad`[which(aux_tbl$k > 0)], n = num_categories_per_side), "`", collapse = ", "), ".", sep = "")
```


 + `P14_GRUPO:Sí` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P14'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P14)[1])
```
 + `P14A_98:No menciona`, `P14A_95:No menciona`, `P14A_12:No menciona`, `P14A_2:No menciona`, `P14A_21:No menciona`, `P14A_1:No menciona`, `P14A_18:No menciona` = No fue contactado por: 
```{r echo=FALSE, results='asis'}
# levels(cis_2020_EB_df$P20)
cat(paste(levels(cis_2020_EB_df$P20)[c(P20_idx_98_nr, P20_idx_95_otro, P20_idx_12_bildu, P20_idx_2_psoe, P20_idx_21_podem, P20_idx_1_pp, P20_idx_18_vox)], collapse = ", "))
```
 + `P14A_11:Menciona`, `P14A_12:Menciona`, `P14A_2:Menciona`, `P14A_21:Menciona`, `P14A_1:Menciona`, `P14A_18:Menciona` = Sí fue contactado por: 
```{r echo=FALSE, results='asis'}
# levels(cis_2020_EB_df$P20)
cat(paste(levels(cis_2020_EB_df$P20)[c(P20_idx_11_pnv, P20_idx_12_bildu, P20_idx_2_psoe, P20_idx_21_podem, P20_idx_1_pp, P20_idx_18_vox)], collapse = ", "))
```
 + `P23_GRUPO:Se habría abstenido o habría votado en blanco ` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P23'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P23)[2])
```
 + `RVAUTO20:No votó/abstención` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'RVAUTO20'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$RVAUTO20)[11])
```
 + `P20_GRUPO:Abstención+` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P20'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P20_GRUPO)[6])
```

 + `P21_GRUPO:No quiso ir a votar` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P21'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P21_GRUPO)[2])
```
 + `P21A_GRUPO:Lo tenía decidido hace bastante tiempo (antes del inicio de la campaña electoral) ` = 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P21A'])
```
: 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P21A_GRUPO)[2])
```
 + `P24_7_GRUPO:2_10` = Escala de probabilidad (0-10) de votar a 
```{r echo=FALSE, results='asis'}
cat(attributes(cis_2020_EB_df)$variable.labels[colnames(cis_2020_EB_df) == 'P24_7'])
```
 en las elecciones autonómicas del País Vasco : 
```{r echo=FALSE, results='asis'}
cat(levels(cis_2020_EB_df$P24_7_GRUPO)[3])
```

ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   


ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   ESTAS AQUI   




`P24_7_GRUPO:2_10`: No descartan votar a "Vox", `P26_4_GRUPO:1 Muy mal`:  valoran muy mal a "Miren Gorrotxategi", `ESCIDEOLPAR_7_GRUPO:1_8`: Opinan que "Vox" no es ultraderecha, `P27:Un Estado con un único Gobierno central sin autonomías `: es su organización territorial preferida, etc.

En el lado negativo del eje están:
```{r echo=FALSE, results='asis'}
j <- 20
cat(paste0("`", head(aux_tbl$`Variable:modalidad`[which(aux_tbl$k < 0)], n = j), "`", collapse = ", "), ".", sep = "")
```

`ESCIDEOLPAR_5_GRUPO:NS_NC`, `ESCIDEOLPAR_7_GRUPO:NS_NC`, `ESCIDEOLPAR_4_GRUPO:NS_NC`, `ESCIDEOLPAR_6_GRUPO:NS_NC`, `ESCIDEOLPAR_1_GRUPO:NS_NC`: no saben o no contestan sobre la escala ideológica de los partidos: "PP", "Vox", "Elkarrekin-Podemos", "Ciudadanos" ni "EAJ-PNV". `P14_GRUPO:No`: no fueron contactados por ningún partido político para pedirles el voto, `P24_3_GRUPO:NS_NC`, `P24_5_GRUPO:NS_NC`, `P24_2_GRUPO:NS_NC`, `P24_4_GRUPO:NS_NC`, `P24_7_GRUPO:NS_NC`, `P24_6_GRUPO:NS_NC`, : No sabe o no contesta sobre la probabilidad de votar a "PSE-EE-PSOE", "PP", "EH-Bildu", "Elkarrekin Podemos" ni "vox".

**Necesito una interpretación *certera* del significado de este eje por parte de JRB. A falta de esa interpretación diremos que:** Este eje representa a las personas que se manifiestan  conservadoras y centralistas y en el lado negativo del eje a los que no saben o no contestan a quien votar.

## Dimensión 4

Se muestran la tabla con las variables más representativas de esta dimensión:

```{r}
percet_eigenvalue <- 0.5
```


```{r}
i <- 4
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, percet_eigenvalue)
require(pander)
pander(aux_tbl, caption = paste0("Dimensión ", i, ". Contiene ", nrow(aux_tbl), " modalidades que cubren el ", 100 * percet_eigenvalue, " % de esta dimensión."))
```

## Dimensión 5

Se muestran la tabla con las variables más representativas de esta dimensión:

```{r}
i <- 5
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, percet_eigenvalue)
require(pander)
pander(aux_tbl, caption = paste0("Dimensión ", i, ". Contiene ", nrow(aux_tbl), " modalidades que cubren el ", 100 * percet_eigenvalue, " % de esta dimensión."))
```

## Dimensión 6

Se muestran la tabla con las variables más representativas de esta dimensión:

```{r}
i <- 6
aux_tbl <- factor_categories(cis_2020_ca_opi01_factor, i, percet_eigenvalue)
require(pander)
pander(aux_tbl, caption = paste0("Dimensión ", i, ". Contiene ", nrow(aux_tbl), " modalidades que cubren el ", 100 * percet_eigenvalue, " % de esta dimensión."))
```






```{r}
# plot(ACM_coches)
# plot(ACM_coches, mass = c(FALSE, TRUE))
# plot(ACM_coches, mass = c(FALSE, TRUE), contrib="absolute")

gg_plot_MCA_cols <- function(dimX = 1, dimY = 2, coord_type = "standard"){

  require(ca)
  # Extracting coordinates from mjca objects
  # type = c("standard", "principal", "symmetric", "rowprincipal", "colprincipal", "symbiplot", "rowgab", "colgab", "rowgreen", "colgreen")
  aux_coord <- ca::cacoord(cis_2020_ca_opi01, type = coord_type, dim = c(dimX, dimY), cols = TRUE, rows = FALSE)
  # dataframe with dimensions coordinates
  my_title <- "Variables activas en el plano factorial"
  col_coord_df <- cbind.data.frame(aux_coord[,1],
                                 aux_coord[,2],
                               cis_2020_ca_opi01$levelnames)

  colnames(col_coord_df) <- c("dimX", "dimY", "name")

  require(ggplot2)
  require(ggrepel)
  # Se crea el objeto con el grafico
  ggplot(col_coord_df, aes(x=col_coord_df$dimX, y=col_coord_df$dimY)) +
    geom_point() + geom_rug() +
    # xlim(-2.6, 3.5) + ylim(-2.1,3.8)+
    geom_text_repel(aes(label=col_coord_df$name),hjust=0, vjust=0,size=3.3) +
    scale_colour_brewer(palette = "Set1") +
    geom_vline(xintercept = 0) + geom_hline(yintercept = 0) + 
    ggtitle(my_title) +
    xlab(paste("Dimension ", dimX, " (", round(100 * cis_2020_ca_opi01$inertia.e[dimX], digits = 1) , "% )", sep = "")) +
    ylab(paste("Dimension ", dimY, " (", round(100 * cis_2020_ca_opi01$inertia.e[dimY], digits = 1) , "% )", sep = ""))
}

# ESTAS AQUI   # ESTAS AQUI   # ESTAS AQUI   # ESTAS AQUI   # ESTAS AQUI   
# TODO: FALTAN colorear los individuos que en alguna ocasion votaron a Otros Partidos

gg_plot_MCA_rows <- function(dimX = 1, dimY = 2, coord_type = "standard"){

  require(ca)
  # Extracting principal from mjca objects
  # type = c("standard", "principal", "symmetric", "rowprincipal", "colprincipal", "symbiplot", "rowgab", "colgab", "rowgreen", "colgreen")
  aux_coord <- ca::cacoord(cis_2020_ca_opi01, type = coord_type, dim = c(dimX, dimY), cols = FALSE, rows = TRUE)
  # dataframe with dimensions coordinates
  my_title <- "Individuos en el plano factorial"
  row_coord_df <- cbind.data.frame(aux_coord[,1],
                                 aux_coord[,2],
                                 1:nrow(aux_coord))
  
  colnames(row_coord_df) <- c("dimX", "dimY", "name")

  require(ggplot2)
  require(ggrepel)
  # Se crea el objeto con el grafico
  ggplot(row_coord_df, aes(x=row_coord_df$dimX, y=row_coord_df$dimY)) +
    geom_point() + geom_rug() +
    # xlim(-2.6, 3.5) + ylim(-2.1,3.8)+
    geom_text_repel(aes(label=row_coord_df$name),hjust=0, vjust=0,size=3.3) +
    scale_colour_brewer(palette = "Set1") +
    geom_vline(xintercept = 0) + geom_hline(yintercept = 0) + 
    ggtitle(my_title) +
    xlab(paste("Dimension ", dimX, " (", round(100 * cis_2020_ca_opi01$inertia.e[dimX], digits = 1) , "% )", sep = "")) +
    ylab(paste("Dimension ", dimY, " (", round(100 * cis_2020_ca_opi01$inertia.e[dimY], digits = 1) , "% )", sep = ""))
}

```



```{r}
gg_plot_MCA_cols(dimX = 1, dimY = 2)
gg_plot_MCA_cols(dimX = 1, dimY = 3)
gg_plot_MCA_cols(dimX = 2, dimY = 3)
```


## Individuos
```{r}
gg_plot_MCA_rows(dimX = 1, dimY = 2)
```

```{r}
gg_plot_MCA_rows(dimX = 1, dimY = 3)
```

```{r}
gg_plot_MCA_rows(dimX = 2, dimY = 3)
```

```{r}
gg_plot_MCA_rows(dimX = 2, dimY = 4)
```




```{r eval=FALSE}
library("RcmdrMisc")

# Funcion que genera el objeto con la figura
getGgplotACM <- function(hCluter_figura, k.optimo=3, titulo = "") {
    # Se crea una columna con el numero de cluster asignado a ese coche
    df_coches.def.ilu.ac$num_cluster <- assignCluster(model.matrix(~-1 +  C1+C2, df_coches.def.ilu.ac), 
                                                      df_coches.def.ilu.ac, cutree(hCluter_figura, k = k.optimo))
    
  ##### coches$num_cluster <- assignCluster(model.matrix(~-1 +  C1+C2, df_coches.def.ilu.ac), df_coches.def.ilu.ac, cutree(hCluter_figura, k = k.optimo))
  
  require(ggplot2)
  figura <- ggplot(df_coches.def.ilu.ac, aes(x=C1, y=C2, color=num_cluster)) +
    geom_point() + geom_rug() +
    geom_vline(xintercept = 0) + geom_hline(yintercept = 0) +
    geom_text_repel(aes(label=rownames(df_coches.def.ilu.ac)),hjust=0, vjust=0, size=3.3) +
    #geom_text(aes(label=rownames(df_coches.def.ilu.ac)),hjust=0, vjust=0, size=3.3) +
    theme(legend.position="top") + ggtitle(titulo)
  
  return(figura)
}

```






A continuación se muestran 
```{r echo=FALSE, results='asis'}
cat(numDim)
```
 tablas que contienen la modalidades más representativas de cada factor (= dimensión). Esas modalidades cubren el 
```{r echo=FALSE, results='asis'}
cat(100 * percet_eigenvalue, "%")
```
 de cada dimensión.




 % del peso de ese factor. Por tanto lo que mejor representa a los encuestados es `N.S.` y `N.C.` y esto no nos aporta *ninguna* información. Así que para realizar este ACM hay que tener en cuenta más dimensiones, o sea más factores.



```{r}
log4r::info(logger,  paste(Sys.time(), 'Ending script'))
```



***

\pagebreak


---
