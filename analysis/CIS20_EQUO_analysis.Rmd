---
title: "CIS 2020 analisis EQUO"
subtitle: "Análisis de datos de encuestas de EQUO y Podemos"
author: "ImJaviPerez"
date: "Marzo 2023"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[RO,RE]{AnálisiS parcial}
- \fancyfoot{}
- \fancyfoot[RE,LO]{Votos 2020}
- \fancyfoot[LE,RO]{\thepage}
bibliography: BibliografiaME.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE)

#    include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
#    echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
#    message = FALSE prevents messages that are generated by code from appearing in the finished file.
#    warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#    fig.cap = "..." adds a caption to graphical results.
#    results='asis' = output as-is, i.e., write raw results from R into the output document
```


```{r include=FALSE}
# Borrar toda las variables
### rm(list=ls())
```

***
```{r}
# List of libraries
library(foreign)
library(dplyr)
library(pander)
library(car)
library(ca)
```

```{r}
library(log4r)
# Create a new logger object with create.logger().
logger <- create.logger()
# Set the logger's file output.
logfile(logger) <- 'cis_2020_analisis.log'
# Set the current level of the logger.
level(logger) <- "DEBUG"
#level(logger) <- "INFO"
# At priority level INFO, a call to debug() won't print anything.
# debug(logger, 'A Debugging Message')
info(logger,  paste(Sys.time(), 'Starting script'))
# warn(logger, 'A Warning Message')
# error(logger, 'An Error Message')
# fatal(logger, 'A Fatal Error Message')

```


```{r}
# TODO
# http://destio.us.es/calvo/asignaturas/ge_esco/tutorialusargitgithubrstudio/UsarGitGithubconRStudio.html
# Seguir indicaciones de JRB
```


\pagebreak

# Análisis de correspondencias múltiples
Datos cualitativos procedentes de encuestas realizadas por el  [Centro de Investigaciones Sociológicas (CIS)](https://www.cis.es) en septiembre de 2020:
[Encuesta 3293/0 POSTELECTORAL DEL PAÍS VASCO. ELECCIONES AUTONÓMICAS 2020](https://www.cis.es/cis/opencm/ES/1_encuestas/estudios/listaMuestras.jsp?estudio=14522).

# Descripción del fichero de datos.

Para conocer las preguntas consultar el fichero: "Estudio: Postelectoral Autonómicas País Vasco 2020 Clave: ECIS3293" del link mencionado anteriormente.


```{r}
# We have to filter CIS 2020 data previously. It spends a lot of time for it's calculations, thus we have made those calculations in an other script and now we load those results.
require(log4r)

cis_2020_cuisine_file <- file.path(getwd(), "cis_2020_equo_cuisine.RData")
if (file.exists(cis_2020_cuisine_file)) {
  load(cis_2020_cuisine_file)
  log4r::info(logger, paste("cis_2020_cuisine_file (", cis_2020_cuisine_file, ") exists =", file.exists(cis_2020_cuisine_file)))
}else{
  log4r::error(logger, paste("File", cis_2020_cuisine_file, "DO NOT EXISTS. You must create this file using the script Cuisine.Rmd"))
  stop(paste("File", cis_2020_cuisine_file, "DO NOT EXISTS. You must create this file using the script Cuisine.Rmd"))
}
```

Ahora, realizamos el ACM en todas las columnas seleccionadas:
```{r ACM}
require(ca) 
cis_2020_equo_ca_00 <- mjca(cis_2020_EB_df[, included_cols_EB_idx])
```

Por defecto la función `mjca` toma el método de escalado `lambda = "adjusted"`, con lo que únicamente se consideran los valores propios obtenidos en el ACM mayores que $\frac{1}{Q} =$
```{r echo=FALSE, results='asis'}
eigen_inertia_e <- 1/Q
cat("\\frac{1}{", Q, "} = ",round(1/Q, digits = 4), ".", sep = "")
```

```{r}
cis_2020_equo_ca_00_summ <- summary(cis_2020_equo_ca_00)
numDim <- length(which(cis_2020_equo_ca_00_summ$scree[,2] > (eigen_inertia_e/2)))
```
Por lo tanto en nuestro caso el número de dimensiones será:
```{r echo=FALSE, results='asis'}
cat(numDim)
```


## Datos objetivos y datos de opinión
Debemos tener en cuenta que hay una serie de variables que son datos objetivos de la persona como por ejemplo su provincia de empadronamiento. A estas características las llamaremos variables *ilustrativas*, que son:

```{r echo=FALSE, results='asis'}
# cat(paste0("'", included_cols_EB, "'", collapse = ", "), sep = "")

# Select some illustrative variables
illustrative_vars <- c('RECUVOTOA_GRUPO', 'RECUVOTOG_GRUPO', 'RVAUTO20_GRUPO', 'RVAUTO16_GRUPO', 'RECUERDO_GRUPO')
# Calculate spare variables
opinion_vars <- included_cols_EB[which(!(included_cols_EB %in% illustrative_vars))]

cat(paste0("`",illustrative_vars, "`", collapse = ", "), sep = "")

# length(illustrative_vars) + length(opinion_vars)
```

El resto de preguntas pueden considerarse de opinión. El ACM trata de ubicar los datos objetivos entre las diferentes escalas de opiniones.

Se realiza una primera tentativa de ACM sólo con las variables de opinión:
```{r ACM01}
cis_2020_ca_opi01 <- mjca(cis_2020_EB_df[,opinion_vars], nd = numDim)

(cis_2020_ca_opi01_summ <- summary(cis_2020_ca_opi01))

plot.mjca(cis_2020_ca_opi01)
```
```{r}
# PRUEBAS 
cis_2020_ca_opi01$inertia.e[1:5]
cis_2020_ca_opi01$inertia.t

cis_2020_ca_opi01_summ$scree[2,]

cis_2020_ca_opi01_summ$scree[1:5,]


```


```{r}
# Create data frame with numDim columns. Each column is a factor and each row is the contribution
cis_2020_EB_ctr_df <- data.frame(matrix(ncol = numDim, nrow = length(cis_2020_ca_opi01_summ$columns[,7])))
colnames(cis_2020_EB_ctr_df) <- paste0("k", seq(1:numDim))
# Contributions of each dimension
for (i in 1:numDim) {
  cis_2020_EB_ctr_df[,i] <- cis_2020_ca_opi01_summ$columns[,7+(i-1)*3]
}
```

Con 
```{r echo=FALSE, results='asis'}
cat(numDim)
```
 dimensiones se explica el 
```{r echo=FALSE, results='asis'}
cat(round(100 * sum(cis_2020_ca_opi01$inertia.e[1:numDim]), digits = 1))
```
 % de la varianza.
 
```{r}
cis_2020_ca_opi01_summ$scree[numDim,]
cis_2020_ca_opi01_summ$scree[numDim,][4]
```

Las primeras
```{r echo=FALSE, results='asis'}
cat(nModalidadesVisualiza <- 60)
```
 variables+modalidades que representan el primer factor y su porcentaje contribución son:

```{r}
cis_2020_ca_opi01_k1_ctr_sort <- sort(cis_2020_EB_ctr_df$k1, decreasing = TRUE, index.return = TRUE)

require(pander)
aux_tbl <- data.frame(cbind(1:nModalidadesVisualiza,
                            cis_2020_ca_opi01_summ$columns$name[cis_2020_ca_opi01_k1_ctr_sort$ix[1:nModalidadesVisualiza]],
                            cis_2020_ca_opi01_k1_ctr_sort$x[1:nModalidadesVisualiza],
                            round(100*cis_2020_ca_opi01_k1_ctr_sort$x[1:nModalidadesVisualiza] / sum(cis_2020_ca_opi01_k1_ctr_sort$x), digits = 1)))
colnames(aux_tbl) <- c("n", "Variable", "Contribución", "%")
pander(aux_tbl)
```

Estas representan el 
```{r echo=FALSE, results='asis'}
round(100*sum(cis_2020_ca_opi01_k1_ctr_sort$x[1:nModalidadesVisualiza])/ sum(cis_2020_ca_opi01_k1_ctr_sort$x), digits = 1)
```
 % del peso de ese factor. O sea que lo que mejor representa a los encuestados es `N.S.` y `N.C.` y esto no nos aporta *ninguna* información. Por tanto para realizar este ACM hay que tener en cuenta más dimensiones, o sea más factores.

```{r}
cis_2020_ca_opi01_k2_ctr_sort <- sort(cis_2020_EB_ctr_df$k2, decreasing = TRUE, index.return = TRUE)

require(pander)
aux_tbl <- data.frame(cbind(1:nModalidadesVisualiza,
                            cis_2020_ca_opi01_summ$columns$name[cis_2020_ca_opi01_k2_ctr_sort$ix[1:nModalidadesVisualiza]],
                            cis_2020_ca_opi01_k2_ctr_sort$x[1:nModalidadesVisualiza],
                            round(100*cis_2020_ca_opi01_k2_ctr_sort$x[1:nModalidadesVisualiza] / sum(cis_2020_ca_opi01_k2_ctr_sort$x), digits = 1)))
colnames(aux_tbl) <- c("n", "Variable", "Contribución", "%")
pander(aux_tbl)
```

Estas representan el 
```{r echo=FALSE, results='asis'}
round(100*sum(cis_2020_ca_opi01_k2_ctr_sort$x[1:nModalidadesVisualiza])/ sum(cis_2020_ca_opi01_k2_ctr_sort$x), digits = 1)
```

```{r}
aux_tbl <- data.frame(cbind(1:length(cis_2020_EB_ctr_df$k1),
                            cis_2020_ca_opi01_summ$columns$name,
                            cis_2020_EB_ctr_df$k1,
                            cis_2020_EB_ctr_df$k2,
                            cis_2020_EB_ctr_df$k3,
                            cis_2020_EB_ctr_df$k4,
                            cis_2020_EB_ctr_df$k5,
                            cis_2020_EB_ctr_df$k6))
colnames(aux_tbl) <- c("n", "Variable:modalidad", "ctr 1", "ctr 2", "ctr 3", "ctr 4", "ctr 5", "ctr 6")

require(pander)
pander(head(aux_tbl))
```



1                                                                                                                       P3_1:Sí
2                                                                                                                       P3_1:No
3                                                                                                                     P3_1:N.C.
4                                                                                                                       P3_2:Sí
5                                                                                                                       P3_2:No
6                                                                                                                     P3_2:N.C.
7                                                                                                                       P3_3:Sí
8                                                                                                                       P3_3:No
9                                                                                                                     P3_3:N.C.
10                                                                                                                      P3_4:Sí
11                                                                                                                      P3_4:No
12                                                                                                                    P3_4:N.C.
13                                                                                                             P5:Conservador/a
14                                                                                                     P5:Demócrata cristiano/a
15                                                                                                                   P5:Liberal
16                                                                                                               P5:Progresista
17                                                                                                           P5:Socialdemócrata
18                                                                                                                P5:Socialista
19                                                                                                                 P5:Comunista
20                                                                                                              P5:Nacionalista
21                                                                                                                 P5:Feminista
22                                                                                                                P5:Ecologista
23                                                                                                         P5:Otras respuestas 
24                                                                                                    P5:(NO LEER) Apolítico/a 
25                                                                                                                      P5:N.S.
26                                                                                                                      P5:N.C.
27                                                                                                                     P6:Mucho
28                                                                                                                  P6:Bastante
29                                                                                                                      P6:Poco
30                                                                                                                      P6:Nada




```{r}
log4r::info(logger,  paste(Sys.time(), 'Ending script'))
```



***

\pagebreak


---
